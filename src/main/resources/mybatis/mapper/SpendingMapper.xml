<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.demo.microservices.dao.SpendingDao">

   <!-- 나의 결제내역 전체 조회 pay_info -->
   <select id="selectSpendingPaymentAll" parameterType="Integer" resultType="com.demo.microservices.model.SpendingVO">

		select pi.pay_id
			 , pi.pay_amt
			 , pi.pay_dt
			 , pi.pay_name
			 , pi.pay_method
			 , case when pi.pay_method = 0 then '현금'
			        else ci.card_name
			   end as pay_method_name
			 , ci.card_id
			 , pi.user_id
			 , pi.process_yn
		  from pay_info pi
		  	   left outer join 
		  	   card_info ci
		  	   on pi.pay_method = ci.card_id
		 where pi.user_id = #{userId}
   </select>

   <!-- 나의 결제내역 중 한개 상세조회 pay_info -->
   <select id="selectSpendingPayment" parameterType="Integer" resultType="com.demo.microservices.model.SpendingVO">

		select pi.pay_id
			 , pi.pay_amt
			 , pi.pay_dt
			 , pi.pay_name
			 , pi.pay_method
			 , case when pi.pay_method = 0 then '현금'
			        else ci.card_name
			   end as pay_method_name
			 , ci.card_id
			 , pi.user_id
			 , pi.process_yn
		  from pay_info pi
		  	   left outer join 
		  	   card_info ci
		  	   on pi.pay_method = ci.card_id
		 where pi.pay_id = #{payId}
   </select>
   
   <!-- 결제내역 등록 -->
   <insert id="insertSpendingPayment" parameterType="com.demo.microservices.model.SpendingVO">
		
		insert into pay_info (
		<!-- pay_id는 ai라서 생략함.. -->
			pay_amt
		  , pay_dt
		  , bal_amt
		  , pay_name
		  , pay_method
		  , user_id
		  , process_yn
		  , input_id
		  , input_dt
		  , modify_id
		  , modify_dt
		)
		values (
		    #{payAmt}
		  , #{payDt}
		  , #{balAmt}
		  , #{payName}
		  , #{payMethod}
		  , #{userId}
		  , #{processYn}
		  , #{userId}
		  , now()
		  , #{userId}
		  , now()
		)
   </insert>
   
   <!-- 결제내역 수정 -->
   <update id="updateSpendingPayment" parameterType="com.demo.microservices.model.SpendingVO">
		update pay_info
		   set pay_id 		= #{payId}
			 , pay_amt 		= #{payAmt}
			 , pay_dt 		= #{payDt}
			 , bal_amt 		= #{balAmt}
			 , pay_name 	= #{payName}
			 , pay_method 	= #{payMethod}
			 , process_yn 	= #{processYn}
			 , modify_id 	= #{userId}
			 , modify_dt 	= now()
       where pay_id = #{payId}
   </update>
   
   <!-- 결제내역 삭제 -->	
   <delete id="deleteSpendingPayment" parameterType="Integer">
 delete from pay_info
       where pay_id = #{payId}
   </delete>






	<!-- ====================================여행별 결제내역==================================== CRUD -->





   <!-- 나의 여행별 결제내역 전체 조회 trvl_pay_info -->
   <select id="selectSpendingTravelAll" parameterType="Integer" resultType="com.demo.microservices.model.SpendingVO">

		select tpi.trvl_pay_id
			 , tpi.trvl_id
			 , tpi.pay_id
			 , tpi.pay_amt
			 , tpi.pay_dt
			 , tpi.pay_name
			 , tpi.pay_method
			 , case when tpi.pay_method = 0 then '현금'
			        else ci.card_name
			   end as pay_method_name
			 , tpi.pay_type
			 , cpt.cm_dtl_cd_nm as pay_type_name
			 , ci.card_id
			 , tpi.user_id
		  from trvl_pay_info tpi
		  	   left outer join 
		  	   card_info ci
		  	   on tpi.pay_method = ci.card_id
		  	   left outer join
		  	   cm_cd_dtl cpt
		  	   on
		  	   cpt.cm_cd = 'pay_type' and
		  	   cpt.cm_dtl_cd = tpi.pay_type
		 where tpi.trvl_id = #{trvlId}
   </select>

   <!-- 나의 여행별 결제내역 중 한개 상세조회 trvl_pay_info -->
   <select id="selectSpendingTravel" parameterType="Integer" resultType="com.demo.microservices.model.SpendingVO">

		select tpi.trvl_pay_id
			 , tpi.pay_amt
			 , tpi.pay_dt
			 , tpi.pay_name
			 , tpi.pay_method
			 , case when tpi.pay_method = 0 then '현금'
			        else ci.card_name
			   end as pay_method_name
			 , tpi.pay_type
			 , cpt.cm_dtl_cd_nm as pay_type_name
			 , ci.card_id
			 , tpi.user_id
		  from trvl_pay_info tpi
		  	   left outer join 
		  	   card_info ci
		  	   on tpi.pay_method = ci.card_id
		  	   left outer join
		  	   cm_cd_dtl cpt
		  	   on
		  	   cpt.cm_cd = 'pay_type' and
		  	   cpt.cm_dtl_cd = tpi.pay_type
		 where tpi.trvl_pay_id = #{trvlPayId}
   </select>
   
   <!-- 여행별 결제내역 등록 -->
   <insert id="insertSpendingTravel" parameterType="com.demo.microservices.model.SpendingVO">
		
		insert into trvl_pay_info (
		<!-- trvl_pay_id는 ai라서 생략함.. -->
			trvl_id
		  , pay_amt
		  , pay_dt
		  , pay_name
		  , pay_method
		  , user_id
		  , pay_type
		  , pay_id
		  , input_id
		  , input_dt
		  , modify_id
		  , modify_dt
		)
		values (
		    #{trvlId}
		  , #{payAmt}
		  , #{payDt}
		  , #{payName}
		  , #{payMethod}
		  , #{userId}
		  , #{payType}
		  , #{payId}
		  , #{userId}
		  , now()
		  , #{userId}
		  , now()
		)
   </insert>
   
   <!-- 여행별 결제내역 수정 -->
   <update id="updateSpendingTravel" parameterType="com.demo.microservices.model.SpendingVO">
		update trvl_pay_info
		   set pay_amt 		= #{payAmt}
			 , pay_dt 		= #{payDt}
			 , pay_name 	= #{payName}
			 , pay_method 	= #{payMethod}
			 , pay_type		= #{payType}
			 , modify_id 	= #{userId}
			 , modify_dt 	= now()
       where trvl_pay_id = #{trvlPayId}
   </update>
   
   <!-- 여행별 결제내역 삭제 -->	
   <delete id="deleteSpendingTravel" parameterType="Integer">
 delete from trvl_pay_info
       where trvl_pay_id = #{trvlPayId}
   </delete>

   <!-- 사용 금액 비율 갱신하기 -->
   <update id="updateSpendingTravelRate" parameterType="Integer">
   
 update trvl_info a
    set total_pay_amt = ifnull((select sum(pay_amt) from trvl_pay_info where trvl_id = a.trvl_id),0)
  where a.trvl_id = #{trvlId};
   
 update trvl_info a
    set total_room_rate = ifnull((select sum(pay_amt) from trvl_pay_info where trvl_id = a.trvl_id and pay_type = '1'),0)/a.total_pay_amt,
        total_food_rate = ifnull((select sum(pay_amt) from trvl_pay_info where trvl_id = a.trvl_id and pay_type = '2'),0)/a.total_pay_amt,
        total_trff_rate = ifnull((select sum(pay_amt) from trvl_pay_info where trvl_id = a.trvl_id and pay_type = '3'),0)/a.total_pay_amt,
        total_act_rate  = ifnull((select sum(pay_amt) from trvl_pay_info where trvl_id = a.trvl_id and pay_type = '4'),0)/a.total_pay_amt ,
        total_etc_rate  = ifnull((select sum(pay_amt) from trvl_pay_info where trvl_id = a.trvl_id and pay_type = '5'),0)/a.total_pay_amt
  where a.trvl_id = #{trvlId};

   </update>

   <!-- 여행결제내역 id로 여행 id 가져오기 -->
   <select id="getTrvlIdWithTrvlPayId" parameterType="Integer" resultType="Integer">

		select tpi.trvl_id
		  from trvl_pay_info tpi
		 where tpi.trvl_pay_id = #{trvlPayId}
   </select>

</mapper>